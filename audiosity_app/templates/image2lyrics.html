{% extends 'base.html' %}

{% block title %}Image zu Bild{% endblock %}

{% block content %}
<h1>Image zu Text</h1>
<p>Auf dieser Seite können Sie sich eine Bildbeschreibung für Ihr Foto generieren lassen.</p>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.as_p }}
    <button type="submit">Upload</button>
</form>

{% if img_obj %}
    <h3>Successfully uploaded: {{ img_obj.title }}</h3>
    <img src="{{ img_obj.image.url }}" alt="Uploaded Image" style="max-height:300px;">
    
    <button id="processButton" data-img-id="{{ img_obj.id }}">Process</button>
    
    <div id="captionContainer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('processButton').addEventListener('click', function() {
                const imgId = this.getAttribute('data-img-id');
                processImage(imgId);
            });
        });

        function processImage(imgId) {
            // Disable the button to prevent multiple submissions
            const button = document.getElementById('processButton');
            button.disabled = true;
            button.textContent = 'Processing...';
    
            // Send an AJAX request to process the image
            fetch(`/process_image/${imgId}/`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'text/html',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.text()) // Expect plain text response
            .then(caption => {
                // Display the caption
                document.getElementById('captionContainer').textContent = caption;
    
                // Hide the process button
                button.style.display = 'none';
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
        }
    </script>
    
{% endif %}
{% endblock %}
